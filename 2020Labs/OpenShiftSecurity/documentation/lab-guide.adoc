= DevSecOps with Containers and Kubernetes
:toc:

=== Reminder Diagrams

Here are the pipelines we'll use in this workshop:

image:images/lab7-hardening-pipeline.png[]
_Image hardening pipeline_

image:images/lab7.3-pipeline.png[]
_Application CI/CD Pipeline_

(Automation is amazing for security, including automated infrastructure creation and deployment. If you're curious about how this lab comes to be, you can find the Ansible role that deploys everything link:https://github.com/redhat-cop/agnosticd/tree/development/ansible/roles/ocp4-workload-security-compliance-lab[here].)

The "image hardening" pipeline scans and creates a foundational block, or "golden image" that developers would use to build their applications on top of (in this case, it's Java). A link:https://catalog.redhat.com/software/containers/detail/5c3592dcd70cc534b3a37814?container-tabs=overview[Universal Base Image (UBI)] is used as the...well, the foundation of the foundation. Compliance and vulnerability scans are performed, and if the compliance percentage is less than 80% or if one or more vulnerabilities are found, the pipeline will fail. The application pipeline is then triggered, using this newly built and vetted base image.

The application CI/CD pipeline takes this golden image and creates a running application by combining it with the source code for that application. We've talked about the security scanning done in this pipeline, and the diagram above also describes it.

=== So...what code are we running??

In this workshop, we'll build a https://spring.io/projects/spring-boot[spring boot] application that mimics an online store. The code for the application will be in the workshop's Gogs repository, but since that repository will go away when our lab environment does, you can also find it https://github.com/RedHatDemos/SecurityDemos/tree/master/2020Labs/OpenShiftSecurity/spring-boot-angular-ecommerce[here].

image:images/lab7-ecommerce-webapp.png[]

=== Logging in to the tools

The login for each tool is listed below. If you see *{USERID}*, replace that with the user ID that you grabbed from Etherpad (user1, user2, etc). 

. OpenShift console - http://console-openshift-console.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com
+
*login:* {USERID}
+
*password:* openshift
+
image:images/lab7.2-openshift.png[]
+
. Gogs - http://gogs-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/
+
*login:* {USERID}
+
*password:* openshift
+
image:images/lab7.2-gogs.png[]
. Jenkins - https://jenkins-{USERID}.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/
(Click on Log In with OpenShift)
+
**login:** {USERID}
+
**password:** openshift
+
When prompted, press the *Allow selected permissions* button.
+
image:images/lab7-jenkinslogin.png[]
+
The main Jenkins page will appear as below:
+
image:images/lab7.2-jenkins.png[]

. Nexus - http://nexus-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/
+
no login necessary!
+
image:images/lab7.2-nexus.png[]
. Sonarqube - https://sonarqube-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/
+
no login necessary!
+
image:images/lab7.2-sonarqube.png[]

. Quay - https://quayecosystem-quay-quay-enterprise.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/
+
**login:** admin
+
**password:** admin123
+
image:images/lab7.2-quay.png[]

=== Explore the image hardening pipeline

These sections explain each piece of the pipeline (called "stages"). You can find the pipeline code at this link (note the {USERID} that has to be updated with your user ID!): http://gogs-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/{USERID}/SecurityDemos/src/master/hardening_pipeline/Jenkinsfile

==== Checkout
Checks out the code to build the image from the Gogs git repository. This includes code to explain how the container should be built as well as bash scripts that perform hardening of the image. These scripts are derived from the remediaton scripts generated by OpenSCAP, in accordance with the Security Technical Implementation Guideline (STIG) for Red Hat Enterprise Linux 7 - which is the operating system our images are built on. Once the code is checked out (the equivalent of doing a git clone to the Jenkins container/server), Jenkins can proceed with the rest of the pipeline.

==== Build / Harden
Creates an image from those inputs retrieved from the git repository. The base image used is the UBI 7 image from Red Hat. The UBI image is free to use and is maintained by Red Hat - and is regularly updated with remediation when new security vulnerabilites (CVEs) are discovered.

==== Push Candidate Image
Uses skopeo to push the newly built candidate image to the Quay image repository.

==== SonarQube Scan
Runs the Maven SonarQube plugin to send the code, unit test results, and code coverage metrics to the SonarQube server for static code analysis.

==== Archive to Nexus
The result of the build is the creation of a Java ARchive, or JAR, file. This file is the Java bytecode that the web application needs to run. We send this JAR file to Nexus for storage so that it can be retrieved in the future if needed (rather than having to rebuild the same version of code). The supported (paid) version of Nexus can also analyze any dependencies used by our uploaded code to look for known vulnerabilities.

==== Build Image
During this step, we use the *Dockerfile* provided along with our source code to construct a new docker image. A *Dockerfile* contains the instructions for how to build a container - it's called a "Dockerfile" because it began with instructions for how to build a Docker image, but is used today to build non-Docker images too. The Dockerfile we are using to deploy the ecommerce application takes a base, Red Hat provided OpenJDK 1.8 image (Open JDK is the Java Development Kit - the runtime required to execute a Java application) and superimposes our executable JAR file on top of it to form a new image that will be used to spin up containers running the application.

==== Push Image to Quay
In this stage we take that Docker image that we just built and push it into Quay, which we're using as a central image repository (much like Nexus above). Quay has also been configured with Clair - which will perform a vulnerability scan of any images pushed to Quay. The Clair report will become available shortly after the image has been pushed into Quay.

==== OpenSCAP Scans
This will perform two OpenSCAP scans: 1) a vulnerability scan, and 2) a Defense Information Systems Agency (DISA) Security Technical Implementation Guideline (STIG) compliance scan. Both reports will be collected by Jenkins and made available for viewing.

==== Compliance Gate
This gate will explicitly examine the OpenSCAP compliance scan results and verify that at least 80% of the STIG compliance requirements have passed. If they _haven't_, it will stop the pipeline.

==== Vulnerability Gate
This gate will explicitly examine the OpenSCAP vulnerability scan results and verify that there are no CVEs detected in the built image. If a CVE is found, this gate will stop the pipeline.

==== Configure Stage Project
Configures the OpenShift staging project (i.e., userid-stage) so that the image can be promoted/released to it.

==== Smoke Test
This stage performs a simple smoke test to make sure the application has some basic level of functionality. In this case, the image is deployed in OpenShift and runs the `java -version` command. If the command returns successfully, the smoke test is passed.

==== Golden Image
At this point in the pipeline, the image has passed all tests (tada!) and can be marked as a "golden image" within Quay.

==== Trigger Application Pipeline
Now that a new, vetted base image has been created, this pipeline can trigger the application pipeline to run. The application pipeline will use this golden image as the base image for building the application. Note that the application pipeline reruns the same compliance/vulnerability tests to verify no potential security issues were introduced in the process of creating the application image.

=== Time to run the image hardening pipeline!

. Navigate back to the jenkins user interface https://jenkins-{USERID}.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/
+
. Click the folder label with your user id (e.g., user1)
+
image:images/lab7.4-jenkins-folder.png[]
+
. Click the hardening pipeline (e.g., user1/openjdk-hardening-pipeline)
+
image:images/lab2.4-jenkins-hardening-pipeline.png[]
+
. Click the *Build with Parameters* link in the left menu
+
image:images/lab2.4-jenkins-hardening-build.png[]
. Keep the default values and press the *Build* button
+
image:images/lab2.4-jenkins-hardening-start-build.png[]

. Click the build label (e.g., #1) next to the build in the *Build History* pane on the left
+
image:images/lab2.4-jenkins-hardening-click-job.png[]
+
. Click the *Console Output* link to monitor the build progress
+
image:images/lab2.4-jenkins-hardening-console.png[]
+
. Wait for the hardening pipeline to complete. Once it finishes, it will automatically start the application CI/CD pipeline, which will use the hardened image as its base.
+
. Scroll to the top of the screen and click the `Open Blue Ocean` link
+
image:images/lab2.4-jenkins-hardening-blueocean.png[]
+
. Click the `Artifacts` link at the top of the screen
+
image:images/lab2.4-jenkins-hardening-artifacts.png[]
+
. Browse the `openscap-compliance-report.html` report and the `openscap-cve-report.html` reports.
+
. Take a look at the source for the Jenkinsfile and hardening scripts located in gogs within the `hardening_pipeline` folder
+
. Open the Dockerfile within the `hardening_pipeline` folder and select the edit button
+
image:images/lab2.4-jenkins-hardening-edit-dockerfile.png[]
. Next we set the image to an old version, to verify the pipeline fails. Change the `FROM` statement on line 1 to
+
```
FROM registry.access.redhat.com/ubi7/ubi:7.6-73
```
+
image:images/lab2.4-jenkins-hardening-image-version.png[]
+
. Comment out the following line in the Dockerfile as well.
+
```
RUN yum update -y && rm -rf /var/cache/yum/ /var/tmp/* /tmp/* /var/tmp/.???* /tmp/.???*
```
+
image:images/lab2.4-jenkins-hardening-yum-update.png[]
+
. Comment out the `yum update -y` line in the `fix-2.sh` remediation script as well:
+
image:images/lab2.4-jenkins-hardening-fix-2-yum.png[]
+
Skipping this `yum update` will prevent the image build from applying CVE fixes.
+
. Click the `Commit Changes` button on the bottom of the page.
+
. From Jenkins, restart the hardening pipeline.
+
. Notice that the compliance gate passed since the hardening script was able to perform compliance remediaton. Go to the blue ocean view again and look at the vulnerability report under `Artifacts`
+
. Revert the FROM statement in the Dockerfile back to:
+
```
FROM registry.access.redhat.com/ubi7/ubi:latest
```
+
and uncomment the `yum update` lines in the `Dockerfile` and `fix-2.sh` script.
+
. Rerun the pipeline to make sure it is once again successful.

=== Explore the application CI/CD pipeline
These sections explain each piece of THIS pipeline. You can find the pipeline code at this link (note the {USERID} that has to be updated with your user ID!):
http://gogs-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/{USERID}/SecurityDemos/src/master/Jenkinsfile

==== Checkout
Checks the _application_ source code out the Gogs git repository. Similar to the Checkout stage of the Image Hardening pipeline, Jenkins will use this code when it builds the artifact. 

==== Build
Uses Apache Maven to build the application (Spring Boot Java). If the build fails, our pipeline will end. _(Woo hoo, fail fast!)_

==== Run Tests
Uses more Maven to run any unit tests that were written. Running the unit tests as part of the pipeline will also collect metrics regarding code coverage, which will be sent to and viewable in SonarQube.

==== SonarQube Scan
Runs the Maven SonarQube plugin to send the code, unit test results, and code coverage metrics to our SonarQube server for static code analysis. This will continue on the SonarQube server while the rest of the pipeline runs.

==== Archive to Nexus
Same as the Image Hardening pipeline, the JAR file is sent to Nexus for archiving. 

==== Build Image
Uses the *Dockerfile* provided for this application to build the image per specifications. 

==== Push Image to Quay
Pushes the image we just built to Quay, where Clair will run a vulnerability scan on _this_ image too. 

==== OpenSCAP Scans
Performs the same OpenSCAP scans as above - whether you would do this a second time in a real pipeline would depend on the potential to introduce new vulnerabilities between the golden image and the application image. 

==== Deploy
Deploys the application into your OpenShift userX project (user1, user2, etc), which will serve as a dev environment. This environment is typically used by developers to verify applications come up as expected and also for performing automated integration tests.

==== OWASP ZAP Scan
Performs an OWASP ZAP baseline scan against the running container image. The resulting report will also be published by Jenkins.

==== Configure Stage Project
Configures the OpenShift staging project (i.e., userX-stage) so that the image can be promoted/moved/deployed into it

==== Promote to Stage?
This step pauses the pipeline and waits for an authorized person (e.g., a QA test lead) to confirm promotion into a higher level environment. In this case, you will be the authorized person, congrats!

==== Configure Prod Project
Configures the OpenShift production project (i.e., userX-prod)

==== Promote to Prod?
Similar to the previous _Promote to Stage?_ step, waits for manual intervention before promoting the application image to an even higher level environment. You are, again, the authorized person, but obviously in the real world this would be someone with "deploy to Production" authority.

=== Time to run the application CI/CD pipeline! 
The Golden Image pipeline will have triggered a run of the CI/CD pipeline when it completed successfully. You can either re-run the pipeline or skip to the results part based on that triggered run.

. Navigate back to the Jenkins user interface https://jenkins-{USERID}.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/
+
. Click the folder label with your user id (e.g., user1)
+
image:images/lab7.4-jenkins-folder.png[]
+
. Click the pipeline (e.g., user1/user1-ecommerce-pipeline)
+
image:images/lab7.4-jenkins-pipeline.png[]
+
. Click the *Build with Parameters* link in the left menu
+
image:images/lab7.4-jenkins-build.png[]
. Keep the default values and press the *Build* button
+
image:images/lab7.4-build-with-params.png[]
+
. Click the build label (e.g., #1) next to the build in the *Build History* pane on the left
+
image:images/lab7.4-jenkins-select-build.png[]
+
. Click the *Console Output* link to monitor the build progress
+
image:images/lab7.4-jenkins-output.png[]
+
. Once the build has completed successfully (and is prompting you to proceed or abort), click the *user#/user#-ecommerce-pipeline* link at the top of the display. We will inspect the security scan artifacts before allowing the pipeline to promote our code into the staging project. *Do not press either of the Proceed or Abort links yet!*
+
image:images/lab7.4-jenkins-build-complete.png[]
+
. Click the the drop down arrow next to the build number in the left hand menu. Select Open Blue Ocean
+
image:images/lab7.4-jenkins-blueocean.png[]
+
Click *Artifacts* in the blue ocean view:
+
image:images/lab7.5-jenkins-blueocean-artifacts.png[]
+
. Then view each of the reports. You may need to refresh the browser.
+
image:images/lab7.5-jenkins-blueocean-artifacts-links.png[]
+

* OpenSCAP Compliance Report
+
Experiment with the filters to adjust the output of the report.
+
image:images/lab7.4-compliance-filters.png[]
* OpenSCAP Vulnerability Report
+
Note the number of vulnerabilities identified by the OpenSCAP Report:
+
image:images/lab7.4-openscap-vulnerabilities.png[]
* OWASP ZAP Baseline Report
+
image:images/lab7.4-owasp-zap.png[]
+
. Navigate to the SonarQube url https://sonarqube-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/ Click on the number link above *Projects Analyzed* section:
+
image:images/lab7.4-sonarqube-projects.png[]
+
. Find the project prefixed with your userid. Note 3 vulnerabilities were found and that the unit test code coverage has been recorded. SonarQube also provides code metrics on items including potential bugs and code smells. Click the Project prefixed with your userid and determine where the vulnerabilities are in the source code.
+
image:images/lab7.4-sonarqube-project-link.png[]
. Navigate to the nexus url http://nexus-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/, click *browse* then *maven-snapshots*
+
image:images/lab7.4-nexus-snapshots.png[]
+
. Navigate the folder structure and verify your JAR file exists within it.
+
image:images/lab7.4-nexus-jar.png[]
. Navigate to the quay url https://quayecosystem-quay-quay-enterprise.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/, login as *admin* with the password *admin123* if you haven't already
+
. Navigate to the image tagged with your userid by clicking the *ecommerce* repository
+
image:images/lab7.4-quay-repo.png[]
+
. Click the tag icon on the left (second icon from the top) then click the image hash id
+
image:images/lab7.4-quay-tag.png[]
. Click the bug icon to see the vulnerabilities detected by Clair. Make a note of the number of vulnerabilities
+
image:images/lab7.4-quay-vulnerabilities.png[]
+
. Click the package icon to see the packages that are affected
+
image:images/lab7.4-quay-packages.png[]
+
. You can also view the deployed application at http://ecommerce-{USERID}.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/

=== Make some changes and watch what happens!

An old base image was used to build the application, we will update that base image in the Dockerfile to use a newer version. This will reduce the number of vulnerabilities that are detected. We'll also update the source code to remove the vulnerabilities detected by SonarQube.

. Navigate to your source code repository in gogs http://gogs-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/ and login if you haven't already ({USERID} / openshift)
+
. Click on the *SecurityDemos* repository under *My Repositories*
+
image:images/lab7.5-gogs-repo.png[]
. Click the *Dockerfile*
+
image:images/lab7.5-gogs-dockerfile.png[]
. Click the edit icon (small pencil) and change the image version from 1.0 to latest.
+
The current line in the Dockerfile is referring to an older image, with associated vulnerabilities.  The latest image we are using will resolve many (potentially all) of these known vulnerabilities. 
+
       FROM registry.access.redhat.com/redhat-openjdk-18/openjdk18-openshift:latest
+
image:images/lab7.5-gogs-edit-dockerfile.png[]
. Click the *Commit Changes* button
+
NOTE: For the purposes of this lab we're committing changes directly into the master branch of our git repository. Probably don't do this in real life. 
+
image:images/lab7.5-gogs-commit-changes.png[]
+
. Navigate back to the root of the SecurityDemos folder.
+
image:images/lab7.5-gogs-navigate-root.png[]
+
. Click on Settings in the top right hand corner.
+
image:images/lab7.5-gogs-settings.png[]
+
. Navigate to the Webhooks tab and then select Gogs from the Add Webhook drop-down menu.
+
image:images/lab7.5-add-gogs-webhook.png[]
+
. Update the payload with the ecommerce pipeline generic webhook (e.g. https://api.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com:6443/apis/build.openshift.io/v1/namespaces/{USERID}/buildconfigs/{USERID}-ecommerce-pipeline/webhooks/{USERID}-ecommerce-pipeline/generic).
+
image:images/lab7.5-add-payload.png[]
+
. Navigate to CodeReady Workspaces http://codeready-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/ and register an account if you haven't already and login ({USERID} / openshift).
+
image:images/lab7.5-crwx-register1.png[]
+
. Select the Java Spring Boot stack and import the SecurityDemos project.
+
NOTE: When entering the Git URL for adding or importing the SecurityDemos project prefix the url with your Gogs username and password, like so: http://{USERID}:openshift@gogs-ocp-workshop.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com/{USERID}/SecurityDemos.git
+
image:images/lab7.5-crwx-stack-project.png[]
+
. Click down through the following folders src -> main -> java -> com -> baeldung -> ecommerce -> controller -> OrderController.java
+
image:images/lab7.5-gogs-src.png[]
+
. Edit the file and remove line 28, which has a hardcoded password. This password is not actually used by the application so it is safe to remove it.
+
image:images/lab7.5-gogs-delete-password.png[]
+
. Click the commit changes button.
+
image:images/lab7.5-crwx-commit-changes.png[]
+
+
. Navigate back to Jenkins and *abort* the current build, then navigate to the pipeline page
+
image:images/lab7.5-jenkins-abort.png[]
+
. Start another build by clicking *Build with Parameters*
+
image:images/lab7.4-jenkins-build.png[]
+
. Then click the *Build* button
+
image:images/lab7.4-build-with-params.png[]
+
. Once the build has started,navigate to the Blue Ocean view of the build.  First select the current build
+
image:images/lab7.5-jenkins-build-2.png[]
+
. Click the *Open Blue Ocean* Link
image:images/lab7.5-jenkins-blueocean.png[]
+
. View the build progress
image:images/lab7.5-jenkins-blueocean-view.png[]
+
. Once the build is complete review the reports, Quay vulnerability scan, and check SonarQube to verify that the number of vulnerabilities has been reduced. Click *Artifacts* in the blue ocean view:
+
image:images/lab7.5-jenkins-blueocean-artifacts.png[]
+
. Then view each of the reports. You may need to refresh the browser.
+
image:images/lab7.5-jenkins-blueocean-artifacts-links.png[]
+
. After viewing the reports, feel free to promote the application image into the staging and prod projects:
+
image:images/lab7.5-jenkins-promote-stage.png[]

+
. The staging version of the app can be viewed here:
+
http://ecommerce-{USERID}-stage.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com
+
image:images/lab7.5-jenkins-promote-prod.png[]
. The production version of the app can be viewed here:
+
http://ecommerce-{USERID}-prod.apps.cluster-uberconf-34f6.uberconf-34f6.example.opentlc.com
+

<<top>>
